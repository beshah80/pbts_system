generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Admin Management
model Admin {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

// Driver Management
model Driver {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  employeeId      String       @unique
  firstName       String
  lastName        String
  licenseNumber   String       @unique
  phoneNumber     String
  email           String?
  password        String
  address         String
  dateOfBirth     DateTime
  hireDate        DateTime
  status          DriverStatus
  experience      Int
  rating          Float        @default(0)
  totalTrips      Int          @default(0)
  emergencyName   String
  emergencyPhone  String
  emergencyRelation String
  photoUrl        String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  buses     Bus[]
  schedules Schedule[]
  incidents Incident[]
  trips     TripRecord[]

  @@map("drivers")
}

// Bus Management
model Bus {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  plateNumber       String    @unique
  busNumber         String    @unique
  fleetNumber       String
  busType           BusType
  status            BusStatus
  capacity          Int
  standingCapacity  Int
  currentPassengers Int       @default(0)
  currentRouteId    String?   @db.ObjectId
  driverId          String?   @db.ObjectId
  lastMaintenance   DateTime?
  nextMaintenance   DateTime?
  mileage           Int?
  fuelLevel         Int?
  gpsEnabled        Boolean   @default(true)
  manufacturer      String
  modelYear         Int
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  driver    Driver?      @relation(fields: [driverId], references: [id])
  route     Route?       @relation(fields: [currentRouteId], references: [id])
  schedules Schedule[]
  incidents Incident[]
  trips     TripRecord[]

  @@map("buses")
}

// Route Management
model Route {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  routeNumber       String   @unique
  routeName         String
  startLocation     String
  endLocation       String
  distanceKm        Float
  estimatedDuration Int
  farePrice         Int
  isActive          Boolean  @default(true)
  operatingStart    String
  operatingEnd      String
  frequency         Int
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  routeStops RouteStop[]
  buses     Bus[]
  schedules Schedule[]
  incidents Incident[]
  feedback  Feedback[]
  trips     TripRecord[]

  @@map("routes")
}

model Stop {
  id         String       @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  latitude   Float
  longitude  Float
  isTerminal Boolean      @default(false)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  routeStops RouteStop[]
  passages  StopPassage[]
  incidents Incident[]

  @@map("stops")
}

model RouteStop {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  routeId               String   @db.ObjectId
  stopId                String   @db.ObjectId
  sequence              Int
  distanceFromStartKm   Float
  estimatedTravelMinutes Int
  
  route Route @relation(fields: [routeId], references: [id])
  stop  Stop  @relation(fields: [stopId], references: [id])

  @@map("route_stops")
}

// Schedule Management
model Schedule {
  id                   String         @id @default(auto()) @map("_id") @db.ObjectId
  routeId              String         @db.ObjectId
  busId                String?        @db.ObjectId
  driverId             String?        @db.ObjectId
  departureTime        String
  arrivalTime          String?
  date                 String?
  dayOfWeek            Int?           // 0=Sunday..6=Saturday
  status               ScheduleStatus?
  actualDepartureTime  String?
  actualArrivalTime    String?
  passengerCount       Int?
  delay                Int?
  frequencyMinutes     Int?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  route  Route   @relation(fields: [routeId], references: [id])
  bus    Bus?    @relation(fields: [busId], references: [id])
  driver Driver? @relation(fields: [driverId], references: [id])

  @@map("schedules")
}

// Trip Management
model TripRecord {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  routeId        String         @db.ObjectId
  busId          String         @db.ObjectId
  driverId       String         @db.ObjectId
  scheduledStart DateTime
  actualStart    DateTime?
  status         TripStatus     @default(PLANNED)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  route        Route           @relation(fields: [routeId], references: [id])
  bus          Bus             @relation(fields: [busId], references: [id])
  driver       Driver          @relation(fields: [driverId], references: [id])
  stopPassages StopPassage[]
  incidents    Incident[]

  @@map("trip_records")
}

model StopPassage {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  tripRecordId String      @db.ObjectId
  stopId       String      @db.ObjectId
  scheduledTime DateTime
  actualTime   DateTime?

  tripRecord TripRecord @relation(fields: [tripRecordId], references: [id])
  stop       Stop       @relation(fields: [stopId], references: [id])

  @@map("stop_passages")
}

// Feedback Management
model Feedback {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  routeId       String?        @db.ObjectId
  rating        Int
  comment       String
  status        FeedbackStatus @default(PENDING)
  contactInfo   String
  submittedAt   DateTime       @default(now())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  route Route? @relation(fields: [routeId], references: [id])

  @@map("feedback")
}

// Incident Management
model Incident {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  busId       String?        @db.ObjectId
  driverId    String?        @db.ObjectId
  routeId     String?        @db.ObjectId
  tripRecordId String?       @db.ObjectId
  stopId      String?        @db.ObjectId
  type        IncidentType
  description String
  location    String?
  latitude    Float?
  longitude   Float?
  status      IncidentStatus @default(REPORTED)
  reportedAt  DateTime       @default(now())
  resolvedAt  DateTime?
  phoneNumber String
  photoUrl    String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  bus        Bus?        @relation(fields: [busId], references: [id])
  driver     Driver?     @relation(fields: [driverId], references: [id])
  route      Route?      @relation(fields: [routeId], references: [id])
  tripRecord TripRecord? @relation(fields: [tripRecordId], references: [id])
  stop       Stop?       @relation(fields: [stopId], references: [id])

  @@map("incidents")
}

// Audit Management
model AuditLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  adminId    String?  @db.ObjectId
  action     String
  entityType String
  entityId   String?
  changes    Json?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@map("audit_logs")
}

// Enums
enum BusType {
  ANBESSA
  SHEGER
  VELOCITY
}

enum BusStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
  OUT_OF_SERVICE
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ScheduleStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TripStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum IncidentType {
  BREAKDOWN
  ACCIDENT
  DELAY
  TRAFFIC
  OTHER
}

enum IncidentStatus {
  REPORTED
  IN_PROGRESS
  RESOLVED
}